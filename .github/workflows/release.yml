name: KRO IDE Release Build

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.1.0)'
        required: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build for macOS (Universal: x64 + arm64)
  build-macos:
    name: Build macOS
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install Dependencies
        run: bun install

      - name: Build Frontend
        run: bun run build

      - name: Build Tauri (Apple Silicon)
        run: |
          cd src-tauri
          cargo build --release --target aarch64-apple-darwin

      - name: Build Tauri (Intel)
        run: |
          cd src-tauri
          cargo build --release --target x86_64-apple-darwin

      - name: Create Universal Binary
        run: |
          lipo -create \
            src-tauri/target/aarch64-apple-darwin/release/kyro-ide \
            src-tauri/target/x86_64-apple-darwin/release/kyro-ide \
            -output src-tauri/target/kyro-ide-universal

      - name: Build DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "KRO IDE" \
            --volicon "src-tauri/icons/icon.icns" \
            --window-pos 200 120 \
            --window-size 800 450 \
            --icon-size 100 \
            --icon "KRO IDE.app" 200 190 \
            --hide-extension "KRO IDE.app" \
            --app-drop-link 600 185 \
            "KRO-IDE-${{ github.ref_name }}-universal.dmg" \
            "src-tauri/target/release/bundle/macos/"

      - name: Upload DMG
        uses: actions/upload-artifact@v7
        with:
          name: kro-ide-macos-universal
          path: "*.dmg"

  # Build for Windows
  build-windows:
    name: Build Windows
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install Dependencies
        run: bun install

      - name: Build Frontend
        run: bun run build

      - name: Build Tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'KRO IDE ${{ github.ref_name }}'
          releaseBody: 'See CHANGELOG.md for details.'
          releaseDraft: true
          prerelease: false
          args: --target x86_64-pc-windows-msvc

      - name: Upload MSI
        uses: actions/upload-artifact@v7
        with:
          name: kro-ide-windows-x64
          path: src-tauri/target/release/bundle/msi/*.msi

  # Build for Linux
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v6

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            patchelf \
            libayatana-appindicator3-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install Dependencies
        run: bun install

      - name: Build Frontend
        run: bun run build

      - name: Build Tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'KRO IDE ${{ github.ref_name }}'
          releaseBody: 'See CHANGELOG.md for details.'
          releaseDraft: true
          prerelease: false
          args: --target x86_64-unknown-linux-gnu

      - name: Upload AppImage
        uses: actions/upload-artifact@v7
        with:
          name: kro-ide-linux-x64
          path: src-tauri/target/release/bundle/appimage/*.AppImage

  # Create GitHub Release
  create-release:
    name: Create Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v6

      - name: Download All Artifacts
        uses: actions/download-artifact@v8
        with:
          path: artifacts

      - name: Display Structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.msi
            artifacts/**/*.AppImage
          generate_release_notes: true
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
